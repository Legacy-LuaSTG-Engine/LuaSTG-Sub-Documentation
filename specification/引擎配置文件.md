# 引擎配置文件

引擎配置文件的目标是用更安全的 `json` 配置文件完全替代 `launch` 脚本。

## 路径预定义变量

引擎提供了以下路径预定义变量：

| 预定义变量 | 说明 | 示例 |
|---|---|---|
| `${AppData}`      | 漫游应用数据目录 | `C:\Users\Example\AppData\Roaming`    |
| `${LocalAppData}` | 本地应用数据目录 | `C:\Users\Example\AppData\Local`      |
| `${Temp}`         | 应用临时文件目录 | `C:\Users\Example\AppData\Local\Temp` |

以上路径预定义变量可用于配置文件中的文件路径或目录路径。

## 主配置文件

配置文件分为主配置文件和附加配置文件。

默认情况下，引擎启动时会读取文件名为 `config.json` 的配置文件作为主配置文件。

默认文件名可以自定义，只需要修改 `LuaSTG/LuaSTG/Custom/Config.h` 中的 `LUASTG_CONFIGURATION_FILE` 宏定义，并重新编译引擎即可。

## 附加配置文件

在主配置文件中可以引入附加配置文件：

```json
{
    "include": [
        { "path": "config1.json" },
        { "path": "config2.json", "optional": true },
        { "path": "config3.json" }
    ]
}
```

`include` 是一个附加配置文件列表（`array`），列表中每一项格式如下：

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|---|---|:---:|---|---|
| `path`     | `string`  | 是 | （必填） | 附加配置文件路径 |
| `optional` | `boolean` | 否 | `false` | 是否允许文件不存在？ |

## 应用程序配置

应用程序配置定义了一些用于与操作系统交互的配置：

```json
{
    "application": {
        "uuid": "37b1a4a0-36fe-4446-a8d1-19691ae44997",
        "single_instance": true
    }
}
```

`application` 是一个对象（`object`），格式如下：

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|---|---|:---:|---|---|
| `uuid`            | `string`  | 否 | `""` | 唯一ID（UUID） |
| `single_instance` | `boolean` | 否 | `false` | 开启后，应用程序无法同时启动多个实例，此时 `uuid` 为必填项 |

## 调试配置

引擎提供了一些通用调试功能（即使编译为发行版）：

```json
{
    "debug": {
        "track_window_focus": false
    }
}
```

`debug` 是一个对象（`object`），格式如下：

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|---|---|:---:|---|---|
| `track_window_focus` | `boolean`  | 否 | `false` | 追踪窗口焦点被哪个应用程序夺取，用于猎杀各种流氓应用 |

## 日志配置

引擎提供了比较丰富的日志支持，支持多种日志输出方式。

### 公共配置

所有的输出方式都有以下公共配置：

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|---|---|:---:|---|---|
| `enable`    | `boolean` | 否 | `false`  | 启用该输出方式 |
| `threshold` | `string`  | 否 | `"info"` | 可填 `debug`、`info`、`warn`、`error`、`fatal`，用于按日志级别过滤日志内容 |

### 调试器打印 `debugger`

> 注意：引擎默认情况下会启用调试器打印，但编译为发行版时调试器打印功能会被移除

调试器打印内部实现为 Windows API `OutputDebugStringA/W`，可在调试模式下打印日志到连接的调试器，比如 Visual Studio C++。

```json
{
    "logging": {
        "debugger": {
            "enable": true,
            "threshold": "debug"
        }
    }
}
```

### 控制台打印 `console`

启用控制台打印后，引擎会额外创建一个控制台窗口，用于实时打印日志。

```json
{
    "logging": {
        "console": {
            "enable": false,
            "threshold": "debug",
            "preserve": true
        }
    }
}
```

控制台打印含有以下特有配置：

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|---|---|:---:|---|---|
| `preserve` | `boolean` | 否 | `false`  | 关闭应用程序后保留控制台窗口 |

### 日志文件 `file`

> 注意：引擎默认情况下会启用日志文件

启用日志文件后，引擎可以将日志打印到文件，即使应用程序关闭，日志内容仍然可以保留。

应用程序每次启动时都会先清空日志文件，如果需要保留历史内容，请使用滚动日志文件功能。

```json
{
    "logging": {
        "file": {
            "enable": true,
            "threshold": "info",
            "path": "engine.log"
        }
    }
}
```

日志文件含有以下特有配置：

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|---|---|:---:|---|---|
| `path` | `string` | 否 | `"engine.log"`  | 文件路径 |

### 滚动日志文件 `rolling_file`

滚动日志文件功能可以保留一定数量的历史日志文件。

```json
{
    "logging": {
         "rolling_file": {
            "enable": true,
            "threshold": "info",
            "path": "userdata/logs/",
            "max_history": 10
        }
    }
}
```

滚动日志文件含有以下特有配置：

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|---|---|:---:|---|---|
| `path`        | `string` | 否 | `"log/"` | 存放滚动日志文件的目录路径 |
| `max_history` | `number` | 否 | `10`     | 最多保留多少个历史日志文件 |

## 文件系统配置

TODO

## 图形系统配置

TODO

## 窗口配置

TODO

## 音频系统配置

TODO

## 配置文件示例

* `config.json`
    ```json
    {
        "include": [
            {
                "path": "userdata/launch.json",
                "optional": true
            }
        ],
        "application": {
            "uuid": "37b1a4a0-36fe-4446-a8d1-19691ae44997",
            "single_instance": true
        },
        "debug": {
            "track_window_focus": false
        },
        "logging": {
            "debugger": {
                "enable": true,
                "threshold": "debug"
            },
            "console": {
                "enable": false,
                "threshold": "debug",
                "preserve": true
            },
            "file": {
                "enable": true,
                "threshold": "info",
                "path": "engine.log"
            },
            "rolling_file": {
                "enable": true,
                "threshold": "info",
                "path": "userdata/logs/",
                "max_history": 10
            }
        },
        "initialize": {
            "file_systems": [
                {
                    "name": "thlib-resources",
                    "type": "normal",
                    "path": "packages/thlib-resources/"
                },
                {
                    "name": "thlib-scripts",
                    "type": "normal",
                    "path": "packages/thlib-scripts/"
                },
                {
                    "name": "thlib-scripts-v2",
                    "type": "normal",
                    "path": "packages/thlib-scripts-v2/"
                }
            ],
            "application": {
                "frame_rate": 60
            },
            "window": {
                "title": "LuaSTG aex+",
                "cursor_visible": false,
                "allow_window_corner": true
            }
        }
    }
    ```
* `userdata/launch.json`
    ```json
    {
        "initialize": {
            "audio_system": {
                "sound_effect_volume": 1,
                "music_volume": 1
            },
            "graphics_system": {
                "width": 640,
                "height": 480,
                "fullscreen": false,
                "vsync": false
            }
        }
    }
    ```

## LuaSTG Sub v0.20.3 到 v0.21.16（已废弃）

> 注意：从 LuaSTG Sub v0.21.17 开始不再支持该格式  

引擎配置文件用于控制一些在 Lua 虚拟机启动之前的行为，比如日志系统、临时文件读写等。  

以下是一个完整的例子，演示了所有字段的使用。  

```json
{
    "log_file_enable": true,
    "log_file_path": "engine.log",
    "persistent_log_file_enable": true,
    "persistent_log_file_directory": "userdata/logs/",
    "persistent_log_file_max_count": 10,
    "engine_cache_directory": "userdata/",
    "single_application_instance": true,
    "application_instance_id": "6514C225-EF44-4F9F-B092-A137F469B0A7",
    "debug_track_window_focus": false
}
```

各字段的说明：
* `log_file_enable`: 是否启用日志文件，默认为 `true` 启用  
* `log_file_path`: 日志文件路径，默认为 `engine.log`  
* `persistent_log_file_enable`: 持久日志文件储存是否启用，默认为 `false` 不启用，启用后将会在持久日志文件储存文件夹中以引擎启动的日期和时间为文件名创建日志文件，且不会主动删除或覆盖  
* `persistent_log_file_directory`: 持久日志文件储存目录，默认为空，即当前工作目录  
* `persistent_log_file_max_count`: 持久日志文件最大数量，如果超过限制会自动将旧的删除  
* `engine_cache_directory`: 其他的一些临时文件或者配置文件的储存路径，比如 `imgui.ini` 文件和 `dump.txt` 文件，默认为空，即当前工作目录  
* `single_application_instance`: 是否禁止程序多开  
* `application_instance_id`: 用于标识程序实例，**必须为不同的项目生成新的GUID，否则会出现两个完全不相关的作品互相阻止启动的问题**  
* `debug_track_window_focus`: 调试功能，用来抓抢占窗口焦点的流氓应用，抢占窗口焦点会导致独占全屏失效、玩家按键没有反应等  

部分路径字段支持在开头填写特殊变量，目前提供以下的特殊变量：  
* `${AppData}`: 展开为 `C:\Users\用户名\AppData\Roaming`  
* `${LocalAppData}`: 展开为 `C:\Users\用户名\AppData\Local`  
* `${Temp}`: 展开为 `C:\Users\用户名\AppData\Local\Temp`  

支持展开的字段如下：  
* `log_file_path`  
* `persistent_log_file_directory`  
* `engine_cache_directory`  

以下是将所有相关的文件存放到 `AppData` 的例子。  

```json
{
    "log_file_enable": true,
    "log_file_path": "${AppData}/X公司或社团/Y产品/engine.log",
    "persistent_log_file_enable": true,
    "persistent_log_file_directory": "${AppData}/X公司或社团/Y产品/logs/",
    "persistent_log_file_max_count": 10,
    "engine_cache_directory": "${AppData}/X公司或社团/Y产品/",
    "single_application_instance": true,
    "application_instance_id": "6514C225-EF44-4F9F-B092-A137F469B0A7",
    "debug_track_window_focus": false
}
```
